#+TITLE: org-modeä¸habiticaçš„è”åŠ¨ä¹‹æ—…
#+AUTHOR: lujun9972
#+TAGS: Emacsä¹‹æ€’
#+DATE: [2022-02-13 æ—¥ 16:14]
#+LANGUAGE:  zh-CN
#+STARTUP:  inlineimages
#+OPTIONS:  H:6 num:nil toc:t \n:nil ::t |:t ^:nil -:nil f:t *:t <:nil

* Habitica ä»‹ç»
[[https://habitica.com/static/features][Habitica]]æ˜¯ä¸€æ®µå°†TODO list æ¸¸æˆåŒ–çš„åº”ç”¨ã€‚
** habiticaçš„ç‰¹ç‚¹ï¼š
+ æ¸¸æˆåŒ–
+ æ¯”è¾ƒæˆç†Ÿçš„ç¤¾äº¤ä½“ç³»ï¼ˆæŒ‘æˆ˜ã€å‰¯æœ¬ã€èŠå¤©ï¼‰
+ [[https://habitica.com/apidoc/][ä¸°å¯Œçš„API]]ï¼Œæ–¹ä¾¿å®ç°è”åŠ¨
+ ä¸°å¯Œçš„æ’ä»¶
  
** habiticaçš„ä»»åŠ¡ä½“ç³»
+ [[https://habitica.fandom.com/zh/wiki/%E4%B9%A0%E6%83%AF][ä¹ æƒ¯]]
+ [[https://habitica.fandom.com/zh/wiki/%E6%AF%8F%E6%97%A5%E4%BB%BB%E5%8A%A1][æ¯æ—¥ä»»åŠ¡]]
+ [[https://habitica.fandom.com/zh/wiki/%E5%BE%85%E5%8A%9E%E4%BA%8B%E9%A1%B9][ä»£åŠäº‹é¡¹]]
+ æ”¯æŒtag
+ å¥–åŠ±

* emacs-habitica package

Emacs å¯ä»¥é€šè¿‡ [[https://github.com/abrochard/emacs-habitica][emacs-habitica]] è¿™ä¸ªåŒ…æ¥å®ç°ä¸ habitica çš„äº¤äº’ã€‚

** è®¾ç½®ç¯å¢ƒå˜é‡
#+begin_src emacs-lisp
  (defvar habitica-uid (getenv "HABITICA_UUID"))
  (defvar habitica-token (getenv "HABITICA_TOKEN"))
#+end_src

** ä¸»ç•Œé¢
=M-x habitica-task=

æ‘˜æŠ„è‡ªGithubä»“åº“è¯´æ˜ï¼š
#+begin_example
  C-x t n => new task
  C-x t t => cycle todo/done
  C-x t + => + a habit
  C-x t - => - a habit
  C-x t d => set deadline
  C-x t i => set difficulty
  C-x t D => delete the task
  C-x t b => buy reward
  C-x t a => add a tag to the task
  C-x t A => remove a tag from the task
  C-x t g => refresh
#+end_example

** èä¸ºä¸€ä½“

é€šè¿‡ä¸‹é¢ä¸‰ä¸ªå‘½ä»¤ï¼Œå¯ä»¥åŒæ­¥ habitica ä¸ org fileä¸­çš„ä»»åŠ¡ï¼š

+ habitica-insert-selected-task :: å°† habitica ä»»åŠ¡æ’å…¥åˆ°org file ä¸­
  
+ habitia-new-task-using-current-headline :: æ ¹æ® org fileä¸­çš„headline ç”Ÿæˆ habitica ä»»åŠ¡

+ habitica-delete-task :: åˆ é™¤ headline ä¸å¯¹åº”çš„ habitica ä»»åŠ¡


é€šè¿‡ä¸‹é¢é…ç½®ï¼Œå¯ä»¥åœ¨ org file å®Œæˆä»»åŠ¡æ—¶ï¼Œè‡ªåŠ¨å®Œæˆ habitica ä¸Šçš„ç›¸åº”ä»»åŠ¡ï¼š
#+begin_src emacs-lisp
  (add-hook 'org-after-todo-state-change-hook 'habitica-task-done-up 'append)
#+end_src

* æˆ‘çš„é…ç½®

** org-pomodoro
ç•ªèŒ„é’Ÿç»“æŸåï¼Œè‡ªåŠ¨å®Œæˆ"ç•ªèŒ„æŒ‘æˆ˜"æ‰“å¡ä»»åŠ¡
#+begin_src emacs-lisp
  (use-package org-pomodoro
    :config
    (setq org-pomodoro-keep-killed-pomodoro-time t)
    (setq org-pomodoro-manual-break t)
    (when (require 'habitica nil t)
      (add-hook 'org-pomodoro-finished-hook (lambda ()
                                              (habitica-api-score-task-by-name "ğŸ…ç•ªèŒ„æŒ‘æˆ˜ğŸ…" "up")))))
#+end_src

** Diary

æ¯æ—¥æ€»ç»“ï¼Œè‡ªåŠ¨è·å–å½“æ—¥å¤©æ°”ã€å®Œæˆçš„ç•ªèŒ„æ•°å’Œåšè¿‡çš„ä»»åŠ¡ï¼š
#+begin_src emacs-lisp
  (setq org-capture-templates
        `(("d" "diary" entry (file org-capture-template--get-daily-file)
           "* å¤©æ°”\n #+begin_example\n%(org-capture-template--get-weather)\n#+end_example\n* ç”Ÿæ´»\t:noexport:\n%?\n\n* å·¥ä½œ\t:noexport:\n\n* ç•ªèŒ„é’Ÿ\n%(org-capture-template--get-pomodoro-count)\n* ä»Šæ—¥äº‹é¡¹\n%(org-capture-template--get-today-entries)\n* æ€»ç»“")))

#+end_src

è·å–å¤©æ°”ä¿¡æ¯:
#+begin_src emacs-lisp
  (defun org-capture-template--get-weather (&optional city)
    "è·å–å¤©æ°”ä¿¡æ¯"
    (interactive)
    (let* ((city (or city "ä¸œè"))
           (url (format "http://wttr.in/%s?0qT" city))
           (url-request-method "GET")
           (url-user-agent "curl/7.78.0")
           (url-request-extra-headers '(("Accept-Language" . "zh")))
           (buffer (url-retrieve-synchronously url))
           (weather (with-current-buffer buffer
                      (goto-char url-http-end-of-headers)
                      (decode-coding-string  (buffer-substring (point) (point-max)) 'utf-8))))
      (kill-buffer buffer)
      weather))
#+end_src

è·å–ä»Šæ—¥åšè¿‡çš„ä»»åŠ¡:
#+begin_src emacs-lisp
  (defun org-capture-template--get-today-entries ()
    "è·å–ä»Šæ—¥åšè¿‡çš„ä»»åŠ¡"
    (let* ((org-agenda-show-log-scoped t)
           (get-today-entries-fn (lambda (file)
                                   (org-agenda-get-day-entries file (calendar-current-date) :closed)))
           (today-entries (delete-dups (mapcan get-today-entries-fn
                                               (org-agenda-files))))
           (org-listify-fn (lambda (entry)
                             (format "+ [ ] %s" entry)))
           (today-entries-list (mapcar org-listify-fn today-entries)))
      (string-join
       today-entries-list
       "\n")))
#+end_src

ä» habitica ä¸­è¯»å–ç•ªèŒ„æŒ‘æˆ˜çš„æ¬¡æ•°:
#+begin_src emacs-lisp
  (defun org-capture-template--get-pomodoro-count ()
    "ä» habitica ä¸­è¯»å–ç•ªèŒ„æŒ‘æˆ˜çš„æ¬¡æ•°"
    (when (require 'habitica nil t)
      (let* ((task (habitica-api-get-task-by-name "ğŸ…ç•ªèŒ„æŒ‘æˆ˜ğŸ…"))
             (history (cdr (assoc-string "history" task)))
             (newest (elt (reverse history) 0))
             (scoredUp (cdr (assoc-string "scoredUp" newest)))
             (date (/ (cdr (assoc-string "date" newest)) 1000))
             (score (if (= (time-to-days (current-time))
                           (time-to-days date))
                        scoredUp
                      0)))
        (format "ğŸ… X %s" score))))
#+end_src

** mobileorg
é€šè¿‡ä¿®æ”¹åŸæœ‰çš„ =org-mobile-edit= å‡½æ•°ï¼Œå®ç°æ‰‹æœºä¸Šæ–°å¢/å®Œæˆä»»åŠ¡æ—¶ä¹ŸåŒæ­¥åœ¨ habitica ä¸Šæ–°å¢/å®Œæˆä»»åŠ¡ã€‚
#+begin_src emacs-lisp
  (defun org-mobile-edit (what old new)
    "Edit item WHAT in the current entry by replacing OLD with NEW.
  WHAT can be \"heading\", \"todo\", \"tags\", \"priority\", or \"body\".
  The edit only takes place if the current value is equal (except for
  white space) the OLD.  If this is so, OLD will be replace by NEW
  and the command will return t.  If something goes wrong, a string will
  be returned that indicates what went wrong."
    (let (current old1 new1 level)
      (if (stringp what) (setq what (intern what)))
      (cond
       ;; çœç•¥
       ((eq what 'addheading)
        (if (org-at-heading-p)            ; if false we are in top-level of file
            (progn
              (org-show-subtree)
              (end-of-line 1)
              (org-insert-heading-respect-content t)
              (org-demote))
          (beginning-of-line)
          (insert "* "))
        (insert new)
        (when (and (functionp #'habitica-new-task)
                   (member "habitica" (org-get-tags)))
          (let ((headlines (nth 4 (org-heading-components))))
            (save-mark-and-excursion
              (while (org-up-heading-safe)
                (setq headlines (concat (nth 4 (org-heading-components)) "-" headlines))))
            (message "habitica-task-name:%s" headlines)
            (habitica--update-properties (habitica-api-create-task "todo" headlines)))))
       ;; çœç•¥
       )))
#+end_src
